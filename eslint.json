[{"filePath":"F:\\02_Projects\\01 Personal\\Certificate downloader\\src\\contexts\\AuthContext.jsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":11,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":11,"endColumn":19},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":175,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":175,"endColumn":21}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/contexts/AuthContext.jsx\r\nimport { createContext, useContext, useEffect, useState } from 'react'\r\nimport { onAuthStateChanged } from 'firebase/auth'\r\nimport { doc, getDoc, setDoc, deleteDoc } from 'firebase/firestore'\r\nimport { auth, db } from '../firebase/firebaseConfig'\r\nimport { signOut } from '../firebase/auth'\r\n\r\n/**\r\n * Valid roles — must match Firestore exactly.\r\n */\r\nexport const ROLES = {\r\n    SUPER_ADMIN: 'PLATFORM_SUPER_ADMIN',\r\n    PRINCIPAL: 'PRINCIPAL',\r\n    HOD: 'HOD',\r\n    STAFF: 'STAFF',\r\n}\r\n\r\nconst AuthContext = createContext(null)\r\n\r\nexport function AuthProvider({ children }) {\r\n    const [currentUser, setCurrentUser] = useState(null)\r\n    const [role, setRole] = useState(null)\r\n    const [orgId, setOrgId] = useState(null)\r\n    const [departmentId, setDepartmentId] = useState(null)\r\n    const [loading, setLoading] = useState(true)\r\n    const [authError, setAuthError] = useState(null)\r\n\r\n    useEffect(() => {\r\n        const unsubscribe = onAuthStateChanged(auth, async (firebaseUser) => {\r\n            setAuthError(null)\r\n\r\n            if (!firebaseUser) {\r\n                // Signed out — clear everything\r\n                setCurrentUser(null)\r\n                setRole(null)\r\n                setOrgId(null)\r\n                setDepartmentId(null)\r\n                setLoading(false)\r\n                return\r\n            }\r\n\r\n            try {\r\n                // Fetch Firestore user document (single source of truth for role)\r\n                const userRef = doc(db, 'users', firebaseUser.uid)\r\n                const userSnap = await getDoc(userRef)\r\n\r\n                if (!userSnap.exists()) {\r\n                    // Check if there is a pending invitation\r\n                    const email = firebaseUser.email\r\n                    if (email) {\r\n                        const invRef = doc(db, 'invitations', email)\r\n                        const invSnap = await getDoc(invRef)\r\n                        if (invSnap.exists()) {\r\n                            const invData = invSnap.data()\r\n                            if (invData.status === 'pending') {\r\n                                // Consume invitation and create user profile\r\n                                await setDoc(userRef, {\r\n                                    uid: firebaseUser.uid,\r\n                                    email: firebaseUser.email,\r\n                                    name: firebaseUser.displayName || 'New User',\r\n                                    photoURL: firebaseUser.photoURL || null,\r\n                                    role: invData.role,\r\n                                    orgId: invData.orgId,\r\n                                    status: 'ACTIVE',\r\n                                    createdAt: new Date()\r\n                                })\r\n                                // Delete the invitation\r\n                                await deleteDoc(invRef)\r\n\r\n                                // Fetch the newly created profile to continue standard flow\r\n                                const newUserSnap = await getDoc(userRef)\r\n                                const data = newUserSnap.data()\r\n                                setCurrentUser({\r\n                                    uid: firebaseUser.uid,\r\n                                    email: firebaseUser.email,\r\n                                    displayName: firebaseUser.displayName,\r\n                                    photoURL: firebaseUser.photoURL,\r\n                                })\r\n                                setRole(data.role)\r\n                                setOrgId(data.orgId || null)\r\n                                setDepartmentId(data.departmentId || null)\r\n                                setLoading(false)\r\n                                return\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    // Firebase auth succeeded but no Firestore document & no invitation — deny access\r\n                    setAuthError('no_firestore_doc')\r\n                    await signOut()         // force sign-out — access denied\r\n                    setCurrentUser(null)\r\n                    setRole(null)\r\n                    setOrgId(null)\r\n                    setDepartmentId(null)\r\n                    setLoading(false)\r\n                    return\r\n                }\r\n\r\n                const data = userSnap.data()\r\n                const validRoles = Object.values(ROLES)\r\n\r\n                if (!validRoles.includes(data.role)) {\r\n                    // Unknown / invalid role in Firestore — deny access\r\n                    setAuthError('invalid_role')\r\n                    await signOut()\r\n                    setCurrentUser(null)\r\n                    setRole(null)\r\n                    setOrgId(null)\r\n                    setDepartmentId(null)\r\n                    setLoading(false)\r\n                    return\r\n                }\r\n\r\n                // Check if the organization is suspended (skip for super admins who don't have an org necessarily or manage everything)\r\n                if (data.orgId && data.role !== ROLES.SUPER_ADMIN) {\r\n                    const orgRef = doc(db, 'organizations', data.orgId)\r\n                    const orgSnap = await getDoc(orgRef)\r\n                    if (orgSnap.exists() && orgSnap.data().suspended) {\r\n                        setAuthError('org_suspended')\r\n                        await signOut()\r\n                        setCurrentUser(null)\r\n                        setRole(null)\r\n                        setOrgId(null)\r\n                        setDepartmentId(null)\r\n                        setLoading(false)\r\n                        return\r\n                    }\r\n                }\r\n\r\n                // All checks passed — set user state\r\n                setCurrentUser({\r\n                    uid: firebaseUser.uid,\r\n                    email: firebaseUser.email,\r\n                    displayName: firebaseUser.displayName,\r\n                    photoURL: firebaseUser.photoURL,\r\n                })\r\n                setRole(data.role)\r\n                setOrgId(data.orgId || null)\r\n                setDepartmentId(data.departmentId || null)\r\n                setLoading(false)\r\n\r\n            } catch (err) {\r\n                console.error('AuthContext: Firestore fetch failed', err)\r\n                setAuthError('firestore_error')\r\n                setCurrentUser(null)\r\n                setRole(null)\r\n                setLoading(false)\r\n            }\r\n        })\r\n\r\n        return unsubscribe\r\n    }, [])\r\n\r\n    const value = {\r\n        currentUser,\r\n        role,\r\n        orgId,\r\n        departmentId,\r\n        loading,\r\n        authError,\r\n        isAuthenticated: !!currentUser,\r\n        isSuperAdmin: role === ROLES.SUPER_ADMIN,\r\n        isPrincipal: role === ROLES.PRINCIPAL,\r\n        isHOD: role === ROLES.HOD,\r\n        isStaff: role === ROLES.STAFF,\r\n    }\r\n\r\n    return (\r\n        <AuthContext.Provider value={value}>\r\n            {children}\r\n        </AuthContext.Provider>\r\n    )\r\n}\r\n\r\nexport const useAuth = () => {\r\n    const ctx = useContext(AuthContext)\r\n    if (!ctx) throw new Error('useAuth must be used within AuthProvider')\r\n    return ctx\r\n}\r\n","usedDeprecatedRules":[]}]